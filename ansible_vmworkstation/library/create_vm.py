#!/usr/bin/python

import json
import sys
import base64
from ansible.module_utils.basic import AnsibleModule
from ansible.module_utils.urls import fetch_url

DOCUMENTATION = r'''
---
module: create_vm

short_description: Create a VMware Workstation VM via vmrest API

description:
  - This module creates a new VM in VMware Workstation by POSTing a VM configuration to the vmrest API.
  - The exact vmrest API schema may differ between versions; this module builds a common JSON body from parameters.

options:
  username:
    description: API username for VMware Workstation (vmrest)
    required: true
    type: str
  password:
    description: API password
    required: true
    type: str
  api_url:
    description: Base URL for the vmrest API (http://host)
    required: false
    type: str
    default: 'http://127.0.0.1'
  api_port:
    description: API port
    required: false
    type: str
    default: '8697'
  name:
    description: Internal VM name (denomination)
    required: true
    type: str
  display_name:
    description: Display name for the VM
    required: false
    type: str
  processors:
    description: Number of CPU processors
    required: false
    type: int
    default: 1
  memory_mb:
    description: RAM in MB
    required: false
    type: int
    default: 1024
  disk_gb:
    description: Disk size in GB (thin-provisioned assumed)
    required: false
    type: int
    default: 8
  iso_path:
    description: Path to an ISO to attach to the VM's CD-ROM (path on the workstation host)
    required: false
    type: str
  vmx_dir:
    description: Directory on the workstation host where the VMX will be created
    required: false
    type: str
    default: ''
  vmx_filename:
    description: VMX filename to register/create (e.g., myvm.vmx)
    required: false
    type: str
  validate_certs:
    description: Validate HTTPS certificates
    required: false
    type: bool
    default: false

author:
  - Generated by assistant
'''

EXAMPLES = r'''
# Create a new VM (note: vmrest API may require different fields per-version)
- name: Create VM
  hosts: localhost
  gather_facts: no
  tasks:
    - name: Create test VM
      create_vm:
        username: "{{ ansible_user }}"
        password: "{{ ansible_password }}"
        api_url: "http://{{ ansible_host }}"
        name: "test-created"
        display_name: "Test Created"
        processors: 2
        memory_mb: 2048
        disk_gb: 20
        iso_path: "C:\\isos\\installer.iso"
        vmx_dir: "C:\\Users\\Public\\VMs\\test-created"
        vmx_filename: "test-created.vmx"
      register: create_res

    - debug: var=create_res
'''

RETURN = r'''
msg:
  description: The JSON response from the vmrest API (if any)
  returned: always
  type: complex
  sample: {}
'''


def run_module():
    module_args = dict(
        username=dict(type='str', required=True),
        password=dict(type='str', required=True),
        api_url=dict(type='str', default='http://127.0.0.1'),
        api_port=dict(type='str', default='8697'),
        name=dict(type='str', required=True),
        display_name=dict(type='str', required=False, default=''),
        processors=dict(type='int', required=False, default=1),
        memory_mb=dict(type='int', required=False, default=1024),
        disk_gb=dict(type='int', required=False, default=8),
        iso_path=dict(type='str', required=False, default=''),
        vmx_dir=dict(type='str', required=False, default=''),
        vmx_filename=dict(type='str', required=False, default=''),
        validate_certs=dict(type='bool', default=False),
        timeout=dict(type='int', default=60),
    )

    result = dict(changed=False, msg='')

    module = AnsibleModule(argument_spec=module_args, supports_check_mode=False)

    api_username = module.params['username']
    api_password = module.params['password']
    creds = api_username + ':' + api_password
    encoded = base64.b64encode(creds.encode('utf-8')).decode('utf-8')
    headers = {
        'Accept': 'application/vnd.vmware.vmw.rest-v1+json',
        'Content-Type': 'application/vnd.vmware.vmw.rest-v1+json',
        'Authorization': 'Basic ' + encoded
    }

    api_url = module.params['api_url']
    api_port = module.params['api_port']

    name = module.params['name']
    display_name = module.params['display_name'] or name
    processors = module.params['processors']
    memory_mb = module.params['memory_mb']
    disk_gb = module.params['disk_gb']
    iso_path = module.params['iso_path']
    vmx_dir = module.params['vmx_dir']
    vmx_filename = module.params['vmx_filename']

    # Build a JSON body â€” vmrest API schemas vary; this is a best-effort minimal body
    body = {
        'name': name,
        'displayName': display_name,
        'processors': processors,
        'memory': memory_mb,
        'disks': [{'sizeGb': disk_gb}],
    }

    if iso_path:
        # Suggest a cdrom device config
        body['cdrom'] = {'isoPath': iso_path}

    if vmx_dir and vmx_filename:
        full_path = vmx_dir.rstrip('\\/') + '/' + vmx_filename
        body['path'] = full_path

    bodyjson = json.dumps(body)

    request_url = api_url + ':' + api_port + '/api/vms'

    req, info = fetch_url(module, request_url, data=bodyjson, headers=headers, method='POST', timeout=module.params['timeout'])

    if req is None:
        module.fail_json(msg='API request failed: %s' % info.get('msg', info))

    result['changed'] = True
    try:
        result['msg'] = json.loads(req.read())
    except Exception:
        result['msg'] = req.read()

    module.exit_json(**result)


def main():
    run_module()


if __name__ == '__main__':
    main()
